{% extends 'base.html' %} {% block title %}Song Generator - Clone Hero Manager{%
endblock %} {% block content %}
<div class="container">
    <h1>üéµ Song Generator</h1>
    <p>
        Upload an audio file and generate a Clone Hero chart with auto-detected
        tempo, beats, and note patterns. Generated songs are uploaded directly
        to Nextcloud.
    </p>

    {% if not webdav_configured %}
    <div class="alert alert-warning">
        ‚ö†Ô∏è <strong>Nextcloud not configured.</strong> Song generation requires a
        configured Nextcloud connection because generated charts are uploaded to
        Nextcloud. Set <code>NEXTCLOUD_URL</code>,
        <code>NEXTCLOUD_USERNAME</code>, and <code>NEXTCLOUD_PASSWORD</code> in
        your <code>.env</code> file.
    </div>
    {% endif %}

    <!-- Generator Form -->
    <div class="upload-section">
        <h2>üé∏ Generate a Chart</h2>

        <form id="generatorForm" enctype="multipart/form-data">
            <div class="form-row">
                <div class="form-group">
                    <label for="songName">Song Name</label>
                    <input
                        type="text"
                        id="songName"
                        name="song_name"
                        placeholder="Leave blank to use filename"
                    />
                </div>
                <div class="form-group">
                    <label for="artistName">Artist</label>
                    <input
                        type="text"
                        id="artistName"
                        name="artist"
                        placeholder="Leave blank for 'Unknown Artist'"
                    />
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="difficulty">Difficulty</label>
                    <select id="difficulty" name="difficulty">
                        <option value="easy">üü¢ Easy</option>
                        <option value="medium">üü° Medium</option>
                        <option value="hard">üü† Hard</option>
                        <option value="expert" selected>üî¥ Expert</option>
                    </select>
                </div>
            </div>

            <!-- Extra Generation Options -->
            <div class="form-row">
                <div class="form-group">
                    <label>Extra Features</label>
                    <div class="checkbox-group">
                        <label class="checkbox-label" for="enableLyrics">
                            <input
                                type="checkbox"
                                id="enableLyrics"
                                name="enable_lyrics"
                                value="true"
                                checked
                            />
                            <span class="checkbox-icon">üé§</span> Generate
                            Lyrics
                            <small class="checkbox-hint"
                                >Procedural lyrics timed to beats, displayed
                                in-game</small
                            >
                        </label>
                        <label class="checkbox-label" for="enableAlbumArt">
                            <input
                                type="checkbox"
                                id="enableAlbumArt"
                                name="enable_album_art"
                                value="true"
                                checked
                            />
                            <span class="checkbox-icon">üé®</span> Generate Album
                            Art
                            <small class="checkbox-hint"
                                >Procedural cover art based on audio features
                                &amp; genre</small
                            >
                        </label>
                    </div>
                </div>
            </div>

            <!-- Drop Zone -->
            <div class="drop-zone" id="dropZone">
                <div class="drop-zone-content" id="dropZoneContent">
                    <div class="drop-zone-icon">üé∂</div>
                    <p class="drop-zone-text">Drag & drop an audio file here</p>
                    <p class="drop-zone-hint">
                        or click to browse ‚Äî MP3, WAV, OGG, FLAC, OPUS
                    </p>
                    <input
                        type="file"
                        id="fileInput"
                        name="file"
                        class="drop-zone-input"
                        accept=".mp3,.ogg,.wav,.flac,.opus"
                        required
                    />
                </div>
                <div
                    class="drop-zone-preview"
                    id="filePreview"
                    style="display: none"
                >
                    <div class="preview-info">
                        <span class="preview-icon" id="previewIcon">üéµ</span>
                        <div class="preview-details">
                            <span class="preview-name" id="previewName"></span>
                            <span class="preview-size" id="previewSize"></span>
                        </div>
                        <button
                            type="button"
                            class="btn btn-danger btn-sm"
                            id="clearFileBtn"
                            title="Remove file"
                        >
                            ‚úï
                        </button>
                    </div>
                </div>
            </div>

            <div
                id="generatorStatus"
                class="status-message"
                style="display: none"
            ></div>

            <!-- Progress -->
            <div
                id="progressContainer"
                class="progress-container"
                style="display: none"
            >
                <div class="progress-bar">
                    <div
                        class="progress-fill indeterminate"
                        id="progressFill"
                    ></div>
                </div>
                <span class="progress-text" id="progressText">‚è≥</span>
            </div>

            <div class="upload-actions">
                <button type="submit" class="btn btn-primary" id="generateBtn">
                    üé∏ Generate Chart
                </button>
                <button type="reset" class="btn btn-secondary" id="resetBtn">
                    üîÑ Reset
                </button>
            </div>
        </form>
    </div>

    <!-- Result Section -->
    <div id="resultSection" class="result-section" style="display: none">
        <h3 id="resultTitle">‚úÖ Chart Generated</h3>
        <div id="resultContent"></div>
        <div class="result-actions">
            <a href="/songs" class="btn btn-primary">üìÅ View Song Library</a>
            <button
                type="button"
                class="btn btn-secondary"
                onclick="resetGenerator()"
            >
                üéµ Generate Another
            </button>
        </div>
    </div>

    <!-- How It Works -->
    <div class="info-section">
        <h2>üìñ How It Works</h2>

        <h3>Step-by-Step Process</h3>
        <ol>
            <li>
                <strong>Upload an Audio File</strong>
                <ul>
                    <li>Supported formats: MP3, WAV, OGG, FLAC, OPUS</li>
                    <li>
                        The file is analysed for tempo, beats, onsets, and
                        rhythm patterns using <code>librosa</code>.
                    </li>
                </ul>
            </li>
            <li>
                <strong>Automatic Chart Generation</strong>
                <ul>
                    <li>
                        BPM (beats per minute) is detected and a stable sync
                        track is generated.
                    </li>
                    <li>
                        Note positions are mapped from onset events to create
                        playable patterns.
                    </li>
                    <li>
                        Section markers (Intro, Verse, Chorus, Bridge, etc.) are
                        estimated via spectral analysis.
                    </li>
                    <li>
                        HOPOs, chords, star power sections, and sustain notes
                        are placed automatically.
                    </li>
                </ul>
            </li>
            <li>
                <strong>üé§ Lyrics Generation <em>(optional)</em></strong>
                <ul>
                    <li>Procedural lyrics are generated and timed to beats.</li>
                    <li>
                        Themed word banks are selected based on genre (rock,
                        pop, metal, electronic, chill, etc.).
                    </li>
                    <li>
                        Chorus phrases repeat for a natural song feel; verses
                        vary.
                    </li>
                    <li>Lyrics appear in Clone Hero's in-game lyric track.</li>
                </ul>
            </li>
            <li>
                <strong>üé® Album Art Generation <em>(optional)</em></strong>
                <ul>
                    <li>
                        A unique 512√ó512 <code>album.png</code> cover is
                        generated procedurally.
                    </li>
                    <li>
                        Colour palette is derived from tempo, energy, and genre.
                    </li>
                    <li>
                        Art style is chosen per genre (geometric, waveform,
                        vinyl, nebula, circuit).
                    </li>
                    <li>Song title and artist are rendered on the cover.</li>
                </ul>
            </li>
            <li>
                <strong>Song Folder Created</strong>
                <ul>
                    <li>
                        A <code>notes.chart</code> file is generated with all
                        four difficulty levels.
                    </li>
                    <li>
                        A <code>song.ini</code> file is created with metadata
                        you provide.
                    </li>
                    <li>The audio file is copied into the song folder.</li>
                    <li>
                        Everything is uploaded to Nextcloud and registered in
                        your library.
                    </li>
                </ul>
            </li>
        </ol>

        <h3>üîç Features</h3>
        <ul>
            <li>
                ‚úÖ Automatic tempo detection and stable beat tracking
                (milli-BPM)
            </li>
            <li>‚úÖ Onset-based note placement for natural-feeling charts</li>
            <li>
                ‚úÖ All 4 difficulty levels (Easy, Medium, Hard, Expert) with
                tailored profiles
            </li>
            <li>‚úÖ Structural section markers via spectral analysis</li>
            <li>‚úÖ HOPOs on close consecutive different-lane notes</li>
            <li>‚úÖ Chords on strong onsets (Hard/Expert)</li>
            <li>‚úÖ Star power sections distributed throughout the song</li>
            <li>‚úÖ Sustain notes on strong onsets with room</li>
            <li>
                ‚úÖ üé§ Procedural lyrics timed to beats with genre-themed word
                banks
            </li>
            <li>‚úÖ üé® Procedural album art derived from audio features</li>
            <li>
                ‚úÖ Variable tempo support (only genuine tempo shifts, not
                jitter)
            </li>
            <li>‚úÖ UTF-8 BOM encoding for Clone Hero compatibility</li>
        </ul>

        <div class="alert alert-info">
            üí° <strong>Tip:</strong> For best results, use high-quality audio
            files. The generator works best with songs that have a clear
            rhythmic structure. You can always edit the generated chart metadata
            afterwards using the <a href="/songs">Song Library</a> editor.
        </div>

        <div class="alert alert-warning">
            ‚ö†Ô∏è <strong>Note:</strong> Chart generation can take 15‚Äì60 seconds
            depending on the length and complexity of the audio file. Please be
            patient during processing.
        </div>
    </div>
</div>
{% endblock %} {% block extra_css %}
<style>
    /* Checkbox group for extra options */
    .checkbox-group {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .checkbox-label {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 14px;
        background: #fff;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        flex-wrap: wrap;
        font-weight: 500;
        color: #2c3e50;
    }

    .checkbox-label:hover {
        border-color: #3498db;
        background: #f0f7ff;
    }

    .checkbox-label input[type="checkbox"] {
        width: 18px;
        height: 18px;
        accent-color: #3498db;
        cursor: pointer;
        flex-shrink: 0;
    }

    .checkbox-label input[type="checkbox"]:checked + .checkbox-icon {
        transform: scale(1.15);
    }

    .checkbox-icon {
        font-size: 1.2em;
        transition: transform 0.2s ease;
        flex-shrink: 0;
    }

    .checkbox-hint {
        display: block;
        width: 100%;
        margin-left: 50px;
        margin-top: 2px;
        font-size: 0.82em;
        color: #7f8c8d;
        font-weight: normal;
    }

    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 15px;
    }

    .drop-zone {
        border: 3px dashed #bdc3c7;
        border-radius: 12px;
        padding: 40px 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: #fafbfc;
        margin-bottom: 20px;
        position: relative;
    }

    .drop-zone:hover {
        border-color: #3498db;
        background: #f0f7ff;
    }

    .drop-zone.drag-over {
        border-color: #2ecc71;
        background: #f0fff4;
        transform: scale(1.01);
        box-shadow: 0 0 20px rgba(46, 204, 113, 0.15);
    }

    .drop-zone.has-file {
        border-color: #3498db;
        border-style: solid;
        background: #f0f7ff;
        padding: 20px;
    }

    .drop-zone-icon {
        font-size: 3em;
        margin-bottom: 10px;
    }

    .drop-zone-text {
        font-size: 1.2em;
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 5px;
    }

    .drop-zone-hint {
        color: #7f8c8d;
        font-size: 0.95em;
    }

    .drop-zone-input {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        cursor: pointer;
    }

    .drop-zone.has-file .drop-zone-input {
        display: none;
    }

    .drop-zone-preview {
        width: 100%;
    }

    .preview-info {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 10px;
        background: white;
        border-radius: 8px;
        border: 1px solid #dee2e6;
    }

    .preview-icon {
        font-size: 2em;
    }

    .preview-details {
        flex: 1;
        text-align: left;
    }

    .preview-name {
        display: block;
        font-weight: bold;
        color: #2c3e50;
        font-size: 1.05em;
        word-break: break-all;
    }

    .preview-size {
        display: block;
        color: #7f8c8d;
        font-size: 0.9em;
        margin-top: 2px;
    }

    .progress-container {
        margin: 20px 0;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .progress-bar {
        flex: 1;
        height: 24px;
        background: #e9ecef;
        border-radius: 12px;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #3498db, #2ecc71);
        border-radius: 12px;
        transition: width 0.3s ease;
        width: 0%;
    }

    .progress-fill.indeterminate {
        width: 100%;
        animation: indeterminate 1.5s ease-in-out infinite;
        background: linear-gradient(
            90deg,
            #3498db 0%,
            #9b59b6 50%,
            #3498db 100%
        );
        background-size: 200% 100%;
    }

    @keyframes indeterminate {
        0% {
            background-position: 200% 0;
        }
        100% {
            background-position: -200% 0;
        }
    }

    .progress-text {
        font-weight: bold;
        color: #2c3e50;
        min-width: 45px;
        text-align: right;
    }

    .upload-actions {
        display: flex;
        gap: 12px;
        margin-top: 10px;
    }

    .result-section {
        background: #f8f9fa;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        padding: 25px;
        margin-bottom: 30px;
    }

    .result-section.success {
        background: #d4edda;
        border-color: #c3e6cb;
    }

    .result-section.error {
        background: #f8d7da;
        border-color: #f5c6cb;
    }

    .result-section h3 {
        margin-top: 0;
        margin-bottom: 15px;
    }

    .result-actions {
        display: flex;
        gap: 10px;
        margin-top: 20px;
    }

    .result-details {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 12px;
        margin: 15px 0;
    }

    .result-detail-item {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 14px 16px;
        text-align: center;
    }

    .result-detail-value {
        display: block;
        font-size: 1.6em;
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 4px;
    }

    .result-detail-label {
        display: block;
        font-size: 0.85em;
        color: #7f8c8d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .result-file-info {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 12px 16px;
        margin-top: 12px;
    }

    .result-file-info p {
        margin: 6px 0;
        color: #495057;
    }

    .result-file-info code {
        background: #e9ecef;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 0.9em;
    }

    @media (max-width: 768px) {
        .form-row {
            grid-template-columns: 1fr;
        }

        .drop-zone {
            padding: 30px 15px;
        }

        .drop-zone-icon {
            font-size: 2.5em;
        }

        .upload-actions,
        .result-actions {
            flex-direction: column;
        }

        .upload-actions .btn,
        .result-actions .btn {
            width: 100%;
            text-align: center;
        }

        .result-details {
            grid-template-columns: repeat(2, 1fr);
        }
    }
</style>
{% endblock %} {% block extra_js %}
<script>
    const dropZone = document.getElementById("dropZone");
    const fileInput = document.getElementById("fileInput");
    const filePreview = document.getElementById("filePreview");
    const dropZoneContent = document.getElementById("dropZoneContent");
    const clearFileBtn = document.getElementById("clearFileBtn");
    const generatorForm = document.getElementById("generatorForm");
    const generateBtn = document.getElementById("generateBtn");
    const statusDiv = document.getElementById("generatorStatus");
    const progressContainer = document.getElementById("progressContainer");
    const progressFill = document.getElementById("progressFill");
    const progressText = document.getElementById("progressText");
    const resultSection = document.getElementById("resultSection");
    const resultTitle = document.getElementById("resultTitle");
    const resultContent = document.getElementById("resultContent");

    // File size formatter
    function formatFileSize(bytes) {
        if (bytes === 0) return "0 Bytes";
        const k = 1024;
        const sizes = ["Bytes", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
    }

    // Format duration
    function formatDuration(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = Math.round(seconds % 60);
        return `${mins}:${secs.toString().padStart(2, "0")}`;
    }

    // Show file preview
    function showFilePreview(file) {
        document.getElementById("previewIcon").textContent = "üéµ";
        document.getElementById("previewName").textContent = file.name;
        document.getElementById("previewSize").textContent = formatFileSize(
            file.size,
        );

        dropZoneContent.style.display = "none";
        filePreview.style.display = "block";
        dropZone.classList.add("has-file");

        // Auto-fill song name from filename if empty
        const songNameInput = document.getElementById("songName");
        if (!songNameInput.value.trim()) {
            const nameWithoutExt = file.name.replace(/\.[^/.]+$/, "");
            songNameInput.value = nameWithoutExt;
        }
    }

    // Clear file selection
    function clearFile() {
        fileInput.value = "";
        dropZoneContent.style.display = "block";
        filePreview.style.display = "none";
        dropZone.classList.remove("has-file");
    }

    // Drag and drop events
    ["dragenter", "dragover"].forEach((eventName) => {
        dropZone.addEventListener(eventName, function (e) {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.add("drag-over");
        });
    });

    ["dragleave", "drop"].forEach((eventName) => {
        dropZone.addEventListener(eventName, function (e) {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.remove("drag-over");
        });
    });

    dropZone.addEventListener("drop", function (e) {
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;
            showFilePreview(files[0]);
        }
    });

    // File input change
    fileInput.addEventListener("change", function () {
        if (this.files.length > 0) {
            showFilePreview(this.files[0]);
        }
    });

    // Clear file button
    clearFileBtn.addEventListener("click", function (e) {
        e.stopPropagation();
        clearFile();
    });

    // Reset form
    generatorForm.addEventListener("reset", function () {
        setTimeout(function () {
            clearFile();
            statusDiv.style.display = "none";
            progressContainer.style.display = "none";
            resultSection.style.display = "none";
        }, 0);
    });

    // Form submission
    generatorForm.addEventListener("submit", async function (e) {
        e.preventDefault();

        if (!fileInput.files || fileInput.files.length === 0) {
            statusDiv.innerHTML =
                '<div class="alert alert-danger">‚ùå Please select an audio file.</div>';
            statusDiv.style.display = "block";
            return;
        }

        const file = fileInput.files[0];
        const songName = document.getElementById("songName").value.trim();
        const artist = document.getElementById("artistName").value.trim();
        const difficulty = document.getElementById("difficulty").value;

        // Disable form during processing
        generateBtn.disabled = true;
        generateBtn.textContent = "‚è≥ Analysing audio...";

        // Show indeterminate progress
        progressContainer.style.display = "flex";
        progressFill.style.width = "";
        progressFill.classList.add("indeterminate");
        progressText.textContent = "‚è≥";

        statusDiv.innerHTML =
            '<div class="alert alert-info">üéµ Uploading audio and analysing tempo, beats, and rhythm patterns... This can take 15‚Äì60 seconds.</div>';
        statusDiv.style.display = "block";
        resultSection.style.display = "none";

        const enableLyrics = document.getElementById("enableLyrics").checked;
        const enableAlbumArt =
            document.getElementById("enableAlbumArt").checked;

        const formData = new FormData();
        formData.append("file", file);
        if (songName) formData.append("song_name", songName);
        if (artist) formData.append("artist", artist);
        formData.append("difficulty", difficulty);

        try {
            formData.append("enable_lyrics", enableLyrics ? "true" : "false");
            formData.append(
                "enable_album_art",
                enableAlbumArt ? "true" : "false",
            );

            const response = await fetch("/api/generate", {
                method: "POST",
                body: formData,
            });

            const result = await response.json();

            // Hide progress and status
            progressContainer.style.display = "none";
            statusDiv.style.display = "none";

            if (response.ok && !result.error) {
                // Success
                resultSection.classList.remove("error");
                resultSection.classList.add("success");
                resultSection.style.display = "block";

                resultTitle.textContent = "‚úÖ Chart Generated Successfully!";

                let html = "";
                const featuresHtml = [];
                if (result.has_lyrics) featuresHtml.push("üé§ Lyrics");
                if (result.has_album_art) featuresHtml.push("üé® Album Art");

                // Stats grid
                html += '<div class="result-details">';
                html += `<div class="result-detail-item">
                <span class="result-detail-value">${result.tempo || "?"}</span>
                <span class="result-detail-label">BPM</span>
            </div>`;
                html += `<div class="result-detail-item">
                <span class="result-detail-value">${result.duration ? formatDuration(result.duration) : "?"}</span>
                <span class="result-detail-label">Duration</span>
            </div>`;
                html += `<div class="result-detail-item">
                <span class="result-detail-value">${result.total_notes || result.total_beats || "?"}</span>
                <span class="result-detail-label">Notes</span>
            </div>`;
                html += `<div class="result-detail-item">
                <span class="result-detail-value">${(result.difficulty || difficulty).charAt(0).toUpperCase() + (result.difficulty || difficulty).slice(1)}</span>
                <span class="result-detail-label">Difficulty</span>
            </div>`;
                if (featuresHtml.length > 0) {
                    html += `<div class="result-detail-item">
                    <span class="result-detail-value">${featuresHtml.join(" ")}</span>
                    <span class="result-detail-label">Features</span>
                </div>`;
                }
                html += "</div>";

                // File details
                html += '<div class="result-file-info">';
                html += `<p><strong>üéµ Song:</strong> ${result.song_name || songName || file.name}</p>`;
                html += `<p><strong>üé§ Artist:</strong> ${result.artist || artist || "Unknown Artist"}</p>`;
                if (result.notes_chart) {
                    html += `<p><strong>üìÑ Chart File:</strong> <code>${result.notes_chart}</code></p>`;
                }
                if (result.output_dir) {
                    html += `<p><strong>üìÇ Song Folder:</strong> <code>${result.output_dir}</code></p>`;
                }
                if (result.id) {
                    html += `<p><strong>üÜî Database ID:</strong> ${result.id}
                    ‚Äî <a href="/songs/${result.id}/edit" class="btn btn-primary btn-sm">‚úèÔ∏è Edit Metadata</a></p>`;
                }
                html += "</div>";

                resultContent.innerHTML = html;
            } else {
                // Error
                resultSection.classList.remove("success");
                resultSection.classList.add("error");
                resultSection.style.display = "block";

                const errMsg =
                    result.detail || result.error || "Chart generation failed";
                resultTitle.textContent = "‚ùå Generation Failed";
                resultContent.innerHTML = `<div class="alert alert-danger">${errMsg}</div>`;
            }
        } catch (error) {
            progressContainer.style.display = "none";
            statusDiv.style.display = "none";

            resultSection.classList.remove("success");
            resultSection.classList.add("error");
            resultSection.style.display = "block";

            resultTitle.textContent = "‚ùå Generation Failed";
            resultContent.innerHTML = `<div class="alert alert-danger">Network error: ${error.message}</div>`;
        } finally {
            generateBtn.disabled = false;
            generateBtn.textContent = "üé∏ Generate Chart";
        }

        resultSection.scrollIntoView({ behavior: "smooth", block: "nearest" });
    });

    function resetGenerator() {
        generatorForm.reset();
        clearFile();
        statusDiv.style.display = "none";
        progressContainer.style.display = "none";
        progressFill.classList.remove("indeterminate");
        resultSection.style.display = "none";
        resultSection.classList.remove("success", "error");
        window.scrollTo({ top: 0, behavior: "smooth" });
    }
</script>
{% endblock %}
