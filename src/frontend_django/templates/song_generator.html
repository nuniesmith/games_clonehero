{% extends 'base.html' %}

{% block title %}Song Generator - Clone Hero Manager{% endblock %}

{% block content %}
<div class="container">
    <h1>üé∏ Clone Hero Song Processor</h1>
    <p>Upload a song file, and we'll process it into Clone Hero format!</p>
    
    <div class="upload-section">
        <h2>üì§ Upload a Song for Processing</h2>
        <form id="generatorForm" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="form-group">
                <label>Choose a song file (MP3, WAV, OPUS, FLAC, OGG):</label>
                <input type="file" name="file" accept=".mp3,.wav,.opus,.flac,.ogg" required>
            </div>
            <button type="submit" class="btn btn-primary">Process Song</button>
        </form>
        
        <div id="processingStatus" class="status-message" style="display:none;"></div>
        <div id="resultSection" style="display:none;" class="result-section">
            <h3>‚úÖ Song Processed Successfully!</h3>
            <p><strong>Generated Notes Chart:</strong> <code id="notesChartPath"></code></p>
            <p><strong>Detected Tempo:</strong> <span id="detectedTempo"></span> BPM</p>
            <button id="downloadBtn" class="btn btn-success">‚¨áÔ∏è Download notes.chart</button>
        </div>
    </div>
    
    <div class="info-section">
        <h2>üìñ How It Works</h2>
        <h3>Step-by-Step Process</h3>
        <ol>
            <li><strong>Upload a Song File</strong>
                <ul>
                    <li>Supported formats: MP3, WAV, OPUS, FLAC, OGG</li>
                    <li>The file is analyzed for tempo, beat detection, and key recognition</li>
                </ul>
            </li>
            <li><strong>Automatic Note Generation</strong>
                <ul>
                    <li>The system detects BPM (beats per minute) and extracts rhythm patterns</li>
                    <li>AI-powered note generation maps the song structure to Clone Hero format</li>
                </ul>
            </li>
            <li><strong>Download & Play</strong>
                <ul>
                    <li>Once processing is complete, you can download the notes.chart file</li>
                    <li>The file is Clone Hero-compatible and ready to be played!</li>
                </ul>
            </li>
        </ol>
        
        <h3>üîç Features of the Processor</h3>
        <ul>
            <li>‚úÖ Automatic Charting based on tempo and rhythm analysis</li>
            <li>‚úÖ Supports Multi-Instrument Tracks (future expansion)</li>
            <li>‚úÖ Handles Variable Tempos using advanced time signature detection</li>
            <li>‚úÖ Error Detection & Prevention to avoid incorrect mappings</li>
        </ul>
        
        <div class="alert alert-info">
            üí° <strong>Need help?</strong> Ensure the file format is correct, and try again. If issues persist, check the server logs.
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('generatorForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const fileInput = this.querySelector('input[type="file"]');
    const statusDiv = document.getElementById('processingStatus');
    const resultSection = document.getElementById('resultSection');
    
    if (!fileInput.files[0]) {
        statusDiv.innerHTML = '<div class="alert alert-danger">Please select a file</div>';
        statusDiv.style.display = 'block';
        return;
    }
    
    const formData = new FormData();
    formData.append('file', fileInput.files[0]);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    statusDiv.innerHTML = '<div class="alert alert-info">Analyzing audio and generating notes...</div>';
    statusDiv.style.display = 'block';
    resultSection.style.display = 'none';
    
    try {
        const response = await fetch('{% url "content:song_generator" %}', {
            method: 'POST',
            body: formData,
        });
        
        const result = await response.json();
        
        if (response.ok && !result.error) {
            statusDiv.style.display = 'none';
            resultSection.style.display = 'block';
            document.getElementById('notesChartPath').textContent = result.notes_chart || 'N/A';
            document.getElementById('detectedTempo').textContent = result.tempo || 'Unknown';
            
            // Setup download button
            const downloadBtn = document.getElementById('downloadBtn');
            downloadBtn.onclick = async function() {
                try {
                    const downloadResponse = await fetch(result.notes_chart);
                    const blob = await downloadResponse.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'notes.chart';
                    a.click();
                } catch (error) {
                    alert(`Download failed: ${error.message}`);
                }
            };
            
            fileInput.value = '';
        } else {
            statusDiv.innerHTML = `<div class="alert alert-danger">üö® Error: ${result.error || 'Processing failed'}</div>`;
        }
    } catch (error) {
        statusDiv.innerHTML = `<div class="alert alert-danger">‚ùå Error: ${error.message}</div>`;
    }
});
</script>
{% endblock %}
