{% extends 'base.html' %} {% block title %}Song Library - Clone Hero Manager{%
endblock %} {% block content %}
<div class="container">
    <h1>üìÅ Song Library</h1>
    <p>
        Browse, search, and manage your Clone Hero song collection. Songs are
        stored on Nextcloud.
    </p>

    {% if not webdav_configured %}
    <div class="alert alert-warning">
        ‚ö†Ô∏è <strong>Nextcloud not configured.</strong> Songs are stored on
        Nextcloud via WebDAV. Set <code>NEXTCLOUD_URL</code>,
        <code>NEXTCLOUD_USERNAME</code>, and <code>NEXTCLOUD_PASSWORD</code> in
        your <code>.env</code> file to enable the song library.
    </div>
    {% endif %}

    <!-- Toolbar -->
    <div class="library-toolbar">
        <!-- Search Form -->
        <form method="get" action="/songs" class="search-form" id="songs-search-form">
            <input type="hidden" name="view" value="{{ view_mode }}" id="view-mode-input" />
            <input
                type="text"
                name="search"
                placeholder="üîç Search by title, artist, or album..."
                value="{{ search_query }}"
                class="search-input"
            />
            <button type="submit" class="btn btn-primary">Search</button>
            {% if search_query %}
            <a href="/songs?view={{ view_mode }}" class="btn btn-secondary">Clear</a>
            {% endif %}
        </form>

        <!-- View Toggle -->
        <div class="view-toggle">
            <a
                href="/songs?view=list{% if search_query %}&search={{ search_query }}{% endif %}"
                class="btn btn-sm {% if view_mode == 'list' %}btn-primary{% else %}btn-secondary{% endif %}"
                title="Flat list view"
            >üìã List</a>
            <a
                href="/songs?view=artists{% if search_query %}&search={{ search_query }}{% endif %}"
                class="btn btn-sm {% if view_mode == 'artists' %}btn-primary{% else %}btn-secondary{% endif %}"
                title="Group by artist"
            >üé§ Artists</a>
        </div>

        <!-- Refresh Library -->
        {% if webdav_configured %}
        <button
            id="sync-library-btn"
            class="btn btn-primary"
            onclick="syncLibrarySSE()"
            title="Scan Nextcloud and refresh the local metadata cache"
        >
            üîÑ Refresh Library
        </button>
        {% endif %}
    </div>

    <div class="search-results-bar">
        {% if view_mode == 'artists' %}
        <p class="search-results">
            {% if search_query %}
            Found {{ total_songs }} song{{ 's' if total_songs != 1 else '' }}
            across {{ total_artists }} artist{{ 's' if total_artists != 1 else '' }}
            for "{{ search_query }}"
            {% else %}
            {{ total_songs }} song{{ 's' if total_songs != 1 else '' }}
            across {{ total_artists }} artist{{ 's' if total_artists != 1 else '' }}
            {% endif %}
        </p>
        {% elif search_query %}
        <p class="search-results">
            Found {{ pagination.total }} result{{ 's' if pagination.total != 1
            else '' }} for "{{ search_query }}"
        </p>
        {% else %}
        <p class="search-results">
            {{ pagination.total }} song{{ 's' if pagination.total != 1 else ''
            }} in library
        </p>
        {% endif %}
    </div>

    <!-- Sync Progress Panel (hidden until sync starts) -->
    <div id="sync-panel" class="sync-panel" style="display: none">
        <div class="sync-panel-header">
            <div class="sync-panel-title">
                <span class="sync-spinner" id="sync-spinner"></span>
                <strong id="sync-panel-heading">Library Sync</strong>
            </div>
            <div class="sync-panel-stats" id="sync-panel-stats"></div>
        </div>

        <!-- Progress bar -->
        <div class="sync-progress-bar-container">
            <div class="sync-progress-bar" id="sync-progress-bar">
                <div class="sync-progress-fill" id="sync-progress-fill"></div>
            </div>
            <span class="sync-progress-pct" id="sync-progress-pct"></span>
        </div>

        <!-- Live event log -->
        <div class="sync-log-wrapper">
            <div class="sync-log" id="sync-log"></div>
        </div>

        <!-- Summary (shown after completion) -->
        <div class="sync-summary" id="sync-summary" style="display: none"></div>

        <div
            class="sync-panel-actions"
            id="sync-panel-actions"
            style="display: none"
        >
            <button
                class="btn btn-primary btn-sm"
                onclick="window.location.reload()"
            >
                üîÑ Reload Page
            </button>
            <button class="btn btn-secondary btn-sm" onclick="closeSyncPanel()">
                ‚úï Dismiss
            </button>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- Artist-grouped view                                    -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    {% if view_mode == 'artists' %}
    <div class="artists-list">
        {% if artists %}
        {% for artist in artists %}
        <div class="artist-accordion" id="artist-{{ loop.index }}">
            <button
                class="artist-accordion-header"
                onclick="toggleArtist(this)"
                aria-expanded="false"
            >
                <span class="artist-accordion-arrow">‚ñ∂</span>
                <span class="artist-accordion-name">üé§ {{ artist.name or 'Unknown Artist' }}</span>
                <span class="artist-accordion-count">{{ artist.song_count }} song{{ 's' if artist.song_count != 1 else '' }}</span>
            </button>
            <div class="artist-accordion-body" style="display: none;">
                {% for song in artist.songs %}
                <div class="song-card song-card-compact" id="song-{{ song.id }}">
                    <div class="song-header">
                        <h3>
                            üéµ {{ song.title }}{% if song.remote_path and
                            song.remote_path.startswith(generator_path) %}
                            <span class="badge badge-staged">üìã Staged</span>{% endif %}
                        </h3>
                        <div class="song-actions">
                            {% if song.remote_path and
                            song.remote_path.startswith(generator_path) %}
                            <button
                                class="btn btn-promote btn-sm promote-song"
                                data-song-id="{{ song.id }}"
                                title="Move from Generator to Songs library"
                                onclick="promoteSong({{ song.id }}, this)"
                            >
                                üöÄ Promote
                            </button>
                            {% endif %}
                            <a
                                href="/songs/{{ song.id }}/edit"
                                class="btn btn-primary btn-sm"
                                title="Edit song metadata"
                            >
                                ‚úèÔ∏è Edit
                            </a>
                            <button
                                class="btn btn-danger btn-sm delete-song"
                                data-song-id="{{ song.id }}"
                                title="Delete song from Nextcloud and library"
                            >
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    </div>
                    <div class="song-details">
                        <p><strong>Album:</strong> {{ song.album or 'Unknown' }}</p>
                        {% if song.remote_path %}
                        <p>
                            <strong>Nextcloud:</strong>
                            <code class="remote-path">{{ song.remote_path }}</code>
                        </p>
                        {% endif %}
                        {% if song.metadata and song.metadata | length > 0 %}
                        <details class="metadata-details">
                            <summary>
                                üîç Show Metadata ({{ song.metadata | length }} fields)
                            </summary>
                            <div class="metadata-grid">
                                {% for key, value in song.metadata.items() %}
                                <div class="metadata-item">
                                    <span class="metadata-key">{{ key }}:</span>
                                    <span class="metadata-value">{{ value }}</span>
                                </div>
                                {% endfor %}
                            </div>
                        </details>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
        {% else %}
        <div class="alert alert-warning">
            {% if search_query %}
            ‚ö†Ô∏è No artists found matching "{{ search_query }}".
            {% elif webdav_configured %}
            ‚ö†Ô∏è No songs in the library yet. Click
            <strong>üîÑ Refresh Library</strong> to scan Nextcloud.
            {% else %}
            ‚ö†Ô∏è No songs in the library. Configure Nextcloud WebDAV to get started.
            {% endif %}
        </div>
        {% endif %}
    </div>
    {% else %}
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- Flat list view (default)                               -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

    <!-- Songs List -->
    <div class="songs-list">
        {% if songs %} {% for song in songs %}
        <div class="song-card" id="song-{{ song.id }}">
            <div class="song-header">
                <h3>
                    üéµ {{ song.title }}{% if song.remote_path and
                    song.remote_path.startswith(generator_path) %}
                    <span class="badge badge-staged">üìã Staged</span>{% endif %}
                </h3>
                <div class="song-actions">
                    {% if song.remote_path and
                    song.remote_path.startswith(generator_path) %}
                    <button
                        class="btn btn-promote btn-sm promote-song"
                        data-song-id="{{ song.id }}"
                        title="Move from Generator to Songs library"
                        onclick="promoteSong({{ song.id }}, this)"
                    >
                        üöÄ Promote
                    </button>
                    {% endif %}
                    <a
                        href="/songs/{{ song.id }}/edit"
                        class="btn btn-primary btn-sm"
                        title="Edit song metadata"
                    >
                        ‚úèÔ∏è Edit
                    </a>
                    <button
                        class="btn btn-danger btn-sm delete-song"
                        data-song-id="{{ song.id }}"
                        title="Delete song from Nextcloud and library"
                    >
                        üóëÔ∏è Delete
                    </button>
                </div>
            </div>
            <div class="song-details">
                <p><strong>Artist:</strong> {{ song.artist }}</p>
                <p><strong>Album:</strong> {{ song.album or 'Unknown' }}</p>
                {% if song.remote_path %}
                <p>
                    <strong>Nextcloud:</strong>
                    <code class="remote-path">{{ song.remote_path }}</code>
                </p>
                {% endif %} {% if song.synced_at %}
                <p><strong>Last synced:</strong> {{ song.synced_at }}</p>
                {% elif song.created_at %}
                <p><strong>Added:</strong> {{ song.created_at }}</p>
                {% endif %} {% if song.metadata and song.metadata | length > 0
                %}
                <details class="metadata-details">
                    <summary>
                        üîç Show Metadata ({{ song.metadata | length }} fields)
                    </summary>
                    <div class="metadata-grid">
                        {% for key, value in song.metadata.items() %}
                        <div class="metadata-item">
                            <span class="metadata-key">{{ key }}:</span>
                            <span class="metadata-value">{{ value }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </details>
                {% endif %}
            </div>
        </div>
        {% endfor %}

        <!-- Pagination -->
        {% if pagination.total_pages > 1 %}
        <div class="pagination">
            {% if pagination.has_previous %}
            <a
                href="/songs?page={{ pagination.previous_page }}&view={{ view_mode }}{% if search_query %}&search={{ search_query }}{% endif %}"
                class="btn btn-secondary"
                >‚¨ÖÔ∏è Previous</a
            >
            {% endif %}

            <span class="page-info">
                Page {{ pagination.page }} of {{ pagination.total_pages }}
            </span>

            {% if pagination.has_next %}
            <a
                href="/songs?page={{ pagination.next_page }}&view={{ view_mode }}{% if search_query %}&search={{ search_query }}{% endif %}"
                class="btn btn-secondary"
                >Next ‚û°Ô∏è</a
            >
            {% endif %}
        </div>
        {% endif %} {% else %}
        <div class="alert alert-warning">
            {% if search_query %} ‚ö†Ô∏è No songs found matching "{{ search_query
            }}". Try a different search term. {% elif webdav_configured %} ‚ö†Ô∏è No
            songs in the library yet. Click
            <strong>üîÑ Refresh Library</strong> to scan Nextcloud, or
            <a href="/upload">upload some songs</a> /
            <a href="/generator">generate a chart</a> to get started! {% else %}
            ‚ö†Ô∏è No songs in the library. Configure Nextcloud WebDAV in your
            <code>.env</code> file to get started. {% endif %}
        </div>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %} {% block extra_css %}
<style>
    /* ‚îÄ‚îÄ View Toggle ‚îÄ‚îÄ */
    .view-toggle {
        display: flex;
        gap: 4px;
        flex-shrink: 0;
    }
    .view-toggle .btn {
        border-radius: 5px;
        font-size: 0.88em;
        white-space: nowrap;
    }

    /* ‚îÄ‚îÄ Artist Accordion ‚îÄ‚îÄ */
    .artists-list {
        margin-top: 0;
    }
    .artist-accordion {
        margin-bottom: 8px;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        overflow: hidden;
        background: #fff;
    }
    .artist-accordion-header {
        display: flex;
        align-items: center;
        gap: 12px;
        width: 100%;
        padding: 14px 18px;
        border: none;
        background: #f8f9fa;
        cursor: pointer;
        font-size: 1.05em;
        font-family: inherit;
        text-align: left;
        transition: background 0.2s ease;
    }
    .artist-accordion-header:hover {
        background: #eef1f5;
    }
    .artist-accordion-header[aria-expanded="true"] {
        background: #e8ecf3;
        border-bottom: 1px solid #dee2e6;
    }
    .artist-accordion-arrow {
        display: inline-block;
        font-size: 0.75em;
        transition: transform 0.25s ease;
        color: #7f8c8d;
        flex-shrink: 0;
        width: 14px;
        text-align: center;
    }
    .artist-accordion-header[aria-expanded="true"] .artist-accordion-arrow {
        transform: rotate(90deg);
    }
    .artist-accordion-name {
        flex: 1;
        font-weight: 600;
        color: #2c3e50;
    }
    .artist-accordion-count {
        font-size: 0.82em;
        color: #95a5a6;
        background: #e9ecef;
        padding: 3px 10px;
        border-radius: 12px;
        white-space: nowrap;
        flex-shrink: 0;
    }
    .artist-accordion-body {
        padding: 8px 12px 12px 12px;
    }
    .artist-accordion-body .song-card-compact {
        margin-bottom: 8px;
        padding: 14px 16px;
    }
    .artist-accordion-body .song-card-compact:last-child {
        margin-bottom: 0;
    }
    .artist-accordion-body .song-header h3 {
        font-size: 1.1em;
    }
    .artist-accordion-body .song-details p {
        margin: 4px 0;
        font-size: 0.92em;
    }

    /* ‚îÄ‚îÄ Expand / Collapse All Controls ‚îÄ‚îÄ */
    .artist-expand-controls {
        display: flex;
        gap: 6px;
        margin-left: auto;
    }
    .artist-expand-controls .btn {
        font-size: 0.82em;
        padding: 4px 10px;
    }

    .badge-staged {
        display: inline-block;
        font-size: 0.65em;
        font-weight: 600;
        padding: 2px 8px;
        border-radius: 6px;
        background: rgba(250, 204, 21, 0.15);
        color: #ca8a04;
        border: 1px solid rgba(250, 204, 21, 0.4);
        vertical-align: middle;
        margin-left: 8px;
    }

    .btn-promote {
        background: linear-gradient(135deg, #8b5cf6, #6d28d9);
        color: #fff;
        border: 1px solid #7c3aed;
    }
    .btn-promote:hover:not(:disabled) {
        background: linear-gradient(135deg, #7c3aed, #5b21b6);
        border-color: #6d28d9;
    }
    .btn-promote:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    .btn-promote.promoted {
        background: #22c55e;
        border-color: #22c55e;
    }

    .library-toolbar {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
        margin-bottom: 10px;
    }

    .library-toolbar .search-form {
        flex: 1;
        display: flex;
        gap: 8px;
        min-width: 280px;
    }

    .search-results-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        margin-bottom: 20px;
    }

    .song-actions {
        display: flex;
        gap: 8px;
        align-items: center;
    }

    .metadata-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 8px;
        padding: 15px;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        margin-top: 10px;
    }

    .metadata-item {
        display: flex;
        gap: 8px;
        padding: 4px 0;
    }

    .metadata-key {
        font-weight: bold;
        color: #2c3e50;
        text-transform: capitalize;
        min-width: 120px;
    }

    .metadata-value {
        color: #495057;
    }

    .remote-path {
        font-size: 0.85em;
        word-break: break-all;
    }

    /* ‚îÄ‚îÄ Sync Panel ‚îÄ‚îÄ */
    .sync-panel {
        background: #f8f9fa;
        border: 2px solid #3498db;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 24px;
        animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .sync-panel.complete {
        border-color: #27ae60;
    }

    .sync-panel.has-errors {
        border-color: #f39c12;
    }

    .sync-panel.error {
        border-color: #e74c3c;
    }

    .sync-panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        flex-wrap: wrap;
        gap: 8px;
    }

    .sync-panel-title {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 1.1em;
    }

    .sync-spinner {
        display: inline-block;
        width: 18px;
        height: 18px;
        border: 3px solid #dee2e6;
        border-top-color: #3498db;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    .sync-spinner.done {
        animation: none;
        border-color: #27ae60;
        border-top-color: #27ae60;
        background: #27ae60;
        position: relative;
    }

    .sync-spinner.error {
        animation: none;
        border-color: #e74c3c;
        border-top-color: #e74c3c;
        background: #e74c3c;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    .sync-panel-stats {
        font-size: 0.88em;
        color: #7f8c8d;
        display: flex;
        gap: 14px;
        flex-wrap: wrap;
    }

    .sync-panel-stats .stat {
        white-space: nowrap;
    }

    .sync-panel-stats .stat-val {
        font-weight: bold;
        color: #2c3e50;
    }

    /* Progress bar */
    .sync-progress-bar-container {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
    }

    .sync-progress-bar {
        flex: 1;
        height: 8px;
        background: #dee2e6;
        border-radius: 4px;
        overflow: hidden;
    }

    .sync-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #3498db, #2ecc71);
        border-radius: 4px;
        width: 0%;
        transition: width 0.3s ease;
    }

    .sync-progress-pct {
        font-size: 0.85em;
        font-weight: bold;
        color: #2c3e50;
        min-width: 40px;
        text-align: right;
    }

    /* Event log */
    .sync-log-wrapper {
        max-height: 220px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        background: #fff;
        scrollbar-width: thin;
    }

    .sync-log {
        padding: 8px 12px;
        font-family: "Consolas", "Fira Code", "Monaco", monospace;
        font-size: 0.82em;
        line-height: 1.6;
    }

    .sync-log-entry {
        display: flex;
        gap: 8px;
        align-items: baseline;
        padding: 2px 0;
        border-bottom: 1px solid #f1f2f3;
        animation: fadeIn 0.2s ease;
    }

    .sync-log-entry:last-child {
        border-bottom: none;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(-4px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .sync-log-icon {
        flex-shrink: 0;
        width: 20px;
        text-align: center;
    }

    .sync-log-msg {
        flex: 1;
        color: #2c3e50;
        word-break: break-word;
    }

    .sync-log-entry.error .sync-log-msg {
        color: #e74c3c;
    }

    .sync-log-entry.success .sync-log-msg {
        color: #27ae60;
    }

    .sync-log-entry.info .sync-log-msg {
        color: #3498db;
    }

    .sync-log-entry.dim .sync-log-msg {
        color: #95a5a6;
    }

    .sync-log-counter {
        flex-shrink: 0;
        font-size: 0.9em;
        color: #95a5a6;
        min-width: 50px;
        text-align: right;
    }

    /* Summary */
    .sync-summary {
        margin-top: 12px;
        padding: 12px 16px;
        border-radius: 5px;
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
        font-size: 0.95em;
    }

    .sync-summary.has-errors {
        background: #fff3cd;
        border-color: #ffeaa7;
        color: #856404;
    }

    .sync-panel-actions {
        display: flex;
        gap: 8px;
        margin-top: 12px;
    }

    @media (max-width: 768px) {
        .library-toolbar {
            flex-direction: column;
        }

        .library-toolbar .search-form {
            width: 100%;
        }

        .view-toggle {
            width: 100%;
            justify-content: stretch;
        }
        .view-toggle .btn {
            flex: 1;
            text-align: center;
        }

        #sync-library-btn {
            width: 100%;
        }

        .sync-panel-header {
            flex-direction: column;
            align-items: flex-start;
        }

        .sync-log-wrapper {
            max-height: 160px;
        }

        .artist-accordion-header {
            padding: 12px 14px;
            font-size: 0.95em;
        }
        .artist-accordion-body {
            padding: 6px 8px 8px 8px;
        }
        .artist-accordion-body .song-card-compact {
            padding: 10px 12px;
        }
        .artist-accordion-body .song-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
        }
        .search-results-bar {
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
        }
        .artist-expand-controls {
            margin-left: 0;
        }
    }
</style>
{% endblock %} {% block extra_js %}
<script>
    // ‚îÄ‚îÄ SSE-powered Library Sync ‚îÄ‚îÄ

    /* ‚îÄ‚îÄ Artist Accordion Toggle ‚îÄ‚îÄ */
    function toggleArtist(btn) {
        const expanded = btn.getAttribute('aria-expanded') === 'true';
        const body = btn.nextElementSibling;
        if (expanded) {
            btn.setAttribute('aria-expanded', 'false');
            body.style.display = 'none';
        } else {
            btn.setAttribute('aria-expanded', 'true');
            body.style.display = 'block';
        }
    }

    /* ‚îÄ‚îÄ Expand / Collapse All Artists ‚îÄ‚îÄ */
    document.addEventListener('DOMContentLoaded', function() {
        // Add expand/collapse all buttons if in artist view
        const artistsList = document.querySelector('.artists-list');
        if (artistsList && artistsList.children.length > 0) {
            const bar = document.querySelector('.search-results-bar');
            if (bar) {
                const controls = document.createElement('div');
                controls.className = 'artist-expand-controls';
                controls.innerHTML =
                    '<button class="btn btn-sm btn-secondary" onclick="expandAllArtists()">‚ñº Expand All</button> ' +
                    '<button class="btn btn-sm btn-secondary" onclick="collapseAllArtists()">‚ñ≤ Collapse All</button>';
                bar.appendChild(controls);
            }
        }
    });

    function expandAllArtists() {
        document.querySelectorAll('.artist-accordion-header').forEach(function(btn) {
            btn.setAttribute('aria-expanded', 'true');
            btn.nextElementSibling.style.display = 'block';
        });
    }

    function collapseAllArtists() {
        document.querySelectorAll('.artist-accordion-header').forEach(function(btn) {
            btn.setAttribute('aria-expanded', 'false');
            btn.nextElementSibling.style.display = 'none';
        });
    }

    let syncEventSource = null;

    function syncLibrarySSE() {
        const btn = document.getElementById("sync-library-btn");
        const panel = document.getElementById("sync-panel");
        const heading = document.getElementById("sync-panel-heading");
        const stats = document.getElementById("sync-panel-stats");
        const progressFill = document.getElementById("sync-progress-fill");
        const progressPct = document.getElementById("sync-progress-pct");
        const log = document.getElementById("sync-log");
        const summary = document.getElementById("sync-summary");
        const actions = document.getElementById("sync-panel-actions");
        const spinner = document.getElementById("sync-spinner");

        // Reset UI
        btn.disabled = true;
        btn.textContent = "‚è≥ Syncing‚Ä¶";
        panel.style.display = "block";
        panel.className = "sync-panel";
        heading.textContent = "Starting sync‚Ä¶";
        stats.innerHTML = "";
        progressFill.style.width = "0%";
        progressPct.textContent = "";
        log.innerHTML = "";
        summary.style.display = "none";
        summary.innerHTML = "";
        actions.style.display = "none";
        spinner.className = "sync-spinner";

        // Scroll panel into view
        panel.scrollIntoView({ behavior: "smooth", block: "start" });

        // Counters
        let synced = 0;
        let failed = 0;
        let total = 0;

        function addLogEntry(icon, msg, cssClass) {
            const entry = document.createElement("div");
            entry.className = "sync-log-entry " + (cssClass || "");

            const iconSpan = document.createElement("span");
            iconSpan.className = "sync-log-icon";
            iconSpan.textContent = icon;

            const msgSpan = document.createElement("span");
            msgSpan.className = "sync-log-msg";
            msgSpan.textContent = msg;

            entry.appendChild(iconSpan);
            entry.appendChild(msgSpan);

            // Add counter for parsing events
            if (total > 0 && (cssClass === "success" || cssClass === "error")) {
                const counter = document.createElement("span");
                counter.className = "sync-log-counter";
                counter.textContent = synced + failed + "/" + total;
                entry.appendChild(counter);
            }

            log.appendChild(entry);

            // Auto-scroll to bottom
            const wrapper = log.parentElement;
            wrapper.scrollTop = wrapper.scrollHeight;
        }

        function updateStats() {
            let html = "";
            if (total > 0) {
                html +=
                    '<span class="stat">üìÇ <span class="stat-val">' +
                    total +
                    "</span> found</span>";
            }
            if (synced > 0) {
                html +=
                    '<span class="stat">‚úÖ <span class="stat-val">' +
                    synced +
                    "</span> synced</span>";
            }
            if (failed > 0) {
                html +=
                    '<span class="stat">‚ùå <span class="stat-val">' +
                    failed +
                    "</span> failed</span>";
            }
            stats.innerHTML = html;
        }

        function finishSync(isError) {
            btn.disabled = false;
            btn.textContent = "üîÑ Refresh Library";
            actions.style.display = "flex";

            if (isError) {
                spinner.className = "sync-spinner error";
                panel.classList.add("error");
            } else if (failed > 0) {
                spinner.className = "sync-spinner done";
                panel.classList.add("complete", "has-errors");
            } else {
                spinner.className = "sync-spinner done";
                panel.classList.add("complete");
            }

            // Trigger sidebar activity refresh
            if (window._refreshActivityIndicator) {
                window._refreshActivityIndicator();
            }
        }

        // Close any existing connection
        if (syncEventSource) {
            syncEventSource.close();
            syncEventSource = null;
        }

        addLogEntry("üîÑ", "Connecting to server‚Ä¶", "info");

        syncEventSource = new EventSource("/api/library/sync/stream");

        syncEventSource.onmessage = function (event) {
            let data;
            try {
                data = JSON.parse(event.data);
            } catch (e) {
                return;
            }

            const type = data.type;

            switch (type) {
                case "start":
                    heading.textContent = "Library Sync";
                    addLogEntry("üöÄ", data.message, "info");
                    break;

                case "discovering":
                    heading.textContent = "Scanning Nextcloud‚Ä¶";
                    addLogEntry("üîç", data.message, "info");
                    progressFill.style.width = "0%";
                    progressPct.textContent = "";
                    break;

                case "discovered":
                    total = data.total || 0;
                    heading.textContent =
                        "Found " + total + " song" + (total !== 1 ? "s" : "");
                    addLogEntry("üìÇ", data.message, "success");
                    updateStats();
                    break;

                case "parsing":
                    {
                        const pct =
                            total > 0
                                ? Math.round((data.index / total) * 100)
                                : 0;
                        progressFill.style.width = pct + "%";
                        progressPct.textContent = pct + "%";
                        heading.textContent =
                            "Parsing " + data.index + "/" + total;
                        // Only log every song (they go fast, don't skip any for visibility)
                        addLogEntry("üìÑ", data.message, "dim");
                        updateStats();
                    }
                    break;

                case "parsed":
                    synced++;
                    {
                        const pct =
                            total > 0
                                ? Math.round((data.index / total) * 100)
                                : 0;
                        progressFill.style.width = pct + "%";
                        progressPct.textContent = pct + "%";
                        heading.textContent =
                            "Syncing " + data.index + "/" + total;

                        const label = data.artist
                            ? data.artist + " ‚Äî " + data.title
                            : data.title || data.folder_display || "?";
                        addLogEntry("‚úÖ", label, "success");
                        updateStats();
                    }
                    break;

                case "parse_error":
                    failed++;
                    addLogEntry("‚ùå", data.message, "error");
                    updateStats();
                    break;

                case "purging":
                    heading.textContent = "Cleaning up‚Ä¶";
                    progressFill.style.width = "100%";
                    progressPct.textContent = "100%";
                    addLogEntry("üßπ", data.message, "info");
                    break;

                case "purged":
                    addLogEntry("üóëÔ∏è", data.message, "info");
                    break;

                case "complete":
                    heading.textContent = "Sync Complete";
                    progressFill.style.width = "100%";
                    progressPct.textContent = "100%";

                    synced = data.synced || synced;
                    failed = data.failed || failed;

                    const purged = data.purged || 0;

                    addLogEntry("üèÅ", data.message, "success");
                    updateStats();

                    // Show summary
                    let summaryParts = [];
                    summaryParts.push(
                        synced +
                            " song" +
                            (synced !== 1 ? "s" : "") +
                            " synced",
                    );
                    if (purged > 0) summaryParts.push(purged + " removed");
                    if (failed > 0) summaryParts.push(failed + " failed");
                    summaryParts.push(
                        data.total_on_nextcloud + " total on Nextcloud",
                    );

                    summary.textContent = "‚úÖ " + summaryParts.join(" ¬∑ ");
                    summary.className =
                        "sync-summary" + (failed > 0 ? " has-errors" : "");
                    summary.style.display = "block";

                    showNotification(
                        "Library sync complete: " + summaryParts.join(", "),
                        failed > 0 ? "warning" : "success",
                    );

                    syncEventSource.close();
                    syncEventSource = null;
                    finishSync(false);
                    break;

                case "error":
                    heading.textContent = "Sync Error";
                    addLogEntry("üí•", data.message, "error");

                    summary.textContent = "‚ùå " + data.message;
                    summary.className = "sync-summary has-errors";
                    summary.style.display = "block";

                    showNotification("Sync error: " + data.message, "danger");

                    syncEventSource.close();
                    syncEventSource = null;
                    finishSync(true);
                    break;
            }
        };

        syncEventSource.onerror = function () {
            // EventSource will auto-reconnect; if the stream is done, close it
            if (
                syncEventSource &&
                syncEventSource.readyState === EventSource.CLOSED
            ) {
                syncEventSource = null;
                // If we never got a 'complete' event, show what we have
                if (
                    !actions.style.display ||
                    actions.style.display === "none"
                ) {
                    heading.textContent = "Connection Lost";
                    addLogEntry("‚ö†Ô∏è", "Connection to server was lost", "error");
                    finishSync(true);
                }
            } else if (syncEventSource) {
                // readyState is CONNECTING ‚Äî the browser is trying to reconnect.
                // Close it; our stream is a one-shot operation, not a persistent channel.
                syncEventSource.close();
                syncEventSource = null;
                if (
                    !actions.style.display ||
                    actions.style.display === "none"
                ) {
                    heading.textContent = "Connection Lost";
                    addLogEntry("‚ö†Ô∏è", "Connection to server was lost", "error");
                    finishSync(true);
                }
            }
        };
    }

    async function promoteSong(songId, btn) {
        const origText = btn.textContent;
        btn.disabled = true;
        btn.textContent = "‚è≥ Moving‚Ä¶";
        try {
            const response = await fetch("/api/songs/" + songId + "/promote", {
                method: "POST",
            });
            const result = await response.json();
            if (!response.ok) {
                const errMsg =
                    result.detail || result.error || "Promote failed";
                alert("‚ùå " + errMsg);
                btn.disabled = false;
                btn.textContent = origText;
                return;
            }
            btn.textContent = "‚úÖ Promoted!";
            btn.className = "btn btn-sm btn-promote promoted";
            // Update the badge
            const card = btn.closest(".song-card");
            if (card) {
                const badge = card.querySelector(".badge-staged");
                if (badge) {
                    badge.textContent = "‚úÖ In Library";
                    badge.style.background = "rgba(74, 222, 128, 0.15)";
                    badge.style.color = "#16a34a";
                    badge.style.borderColor = "rgba(74, 222, 128, 0.4)";
                }
                const pathCode = card.querySelector(".remote-path");
                if (pathCode && result.new_path) {
                    pathCode.textContent = result.new_path;
                }
            }
        } catch (err) {
            alert("‚ùå Network error: " + err.message);
            btn.disabled = false;
            btn.textContent = origText;
        }
    }

    function closeSyncPanel() {
        const panel = document.getElementById("sync-panel");
        panel.style.display = "none";
    }

    // Delete song (from Nextcloud + DB)
    document.querySelectorAll(".delete-song").forEach((button) => {
        button.addEventListener("click", async function () {
            const songId = this.getAttribute("data-song-id");
            const card = document.getElementById("song-" + songId);
            const songTitle = card.querySelector("h3").textContent.trim();

            if (
                !confirm(
                    'Are you sure you want to delete "' +
                        songTitle +
                        '"?\n\nThis will remove the song from Nextcloud AND the local library.',
                )
            ) {
                return;
            }

            this.disabled = true;
            this.textContent = "‚è≥‚Ä¶";

            try {
                const response = await fetch("/api/songs/" + songId, {
                    method: "DELETE",
                });

                const result = await response.json();

                if (response.ok) {
                    card.style.transition = "opacity 0.5s, transform 0.5s";
                    card.style.opacity = "0";
                    card.style.transform = "translateX(-20px)";
                    setTimeout(() => {
                        card.innerHTML =
                            '<div class="alert alert-success">‚úÖ Song deleted from Nextcloud and library.</div>';
                        card.style.opacity = "1";
                        card.style.transform = "none";
                        setTimeout(() => card.remove(), 2000);
                    }, 500);
                } else {
                    alert(
                        "Error deleting song: " +
                            (result.detail || result.error || "Unknown error"),
                    );
                    this.disabled = false;
                    this.textContent = "üóëÔ∏è Delete";
                }
            } catch (error) {
                alert("Error: " + error.message);
                this.disabled = false;
                this.textContent = "üóëÔ∏è Delete";
            }
        });
    });
</script>
{% endblock %}
