{% extends 'base.html' %} {% block title %}Song Generator - Clone Hero Manager{%
endblock %} {% block content %}
<div class="container">
    <h1>üé∏ Song Generator</h1>
    <p class="subtitle">
        Drop an audio file to generate a Clone Hero chart. Metadata is
        automatically detected from the filename and looked up online.
    </p>

    {% if not webdav_configured %}
    <div class="alert alert-warning">
        ‚ö†Ô∏è <strong>Nextcloud not configured.</strong> Generated charts need
        Nextcloud to be stored. Configure your <code>.env</code> file.
    </div>
    {% endif %}

    <!-- Generator Form -->
    <div class="gen-card">
        <form id="generatorForm" enctype="multipart/form-data">
            <!-- Drop Zone -->
            <div class="drop-zone" id="dropZone">
                <div class="drop-zone-content" id="dropZoneContent">
                    <div class="drop-zone-icon">
                        <svg
                            width="48"
                            height="48"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="1.5"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                        >
                            <path d="M9 18V5l12-2v13" />
                            <circle cx="6" cy="18" r="3" />
                            <circle cx="18" cy="16" r="3" />
                        </svg>
                    </div>
                    <p class="drop-zone-text">
                        Drag &amp; drop an audio file here
                    </p>
                    <p class="drop-zone-hint">
                        MP3 &bull; OGG &bull; FLAC &bull; WAV &bull; OPUS
                    </p>
                    <input
                        type="file"
                        id="fileInput"
                        name="file"
                        class="drop-zone-input"
                        accept=".mp3,.ogg,.wav,.flac,.opus"
                        required
                    />
                </div>
                <div
                    class="drop-zone-preview"
                    id="filePreview"
                    style="display: none"
                >
                    <div class="preview-card">
                        <div class="preview-icon" id="previewIcon">üéµ</div>
                        <div class="preview-details">
                            <span class="preview-name" id="previewName"></span>
                            <span class="preview-size" id="previewSize"></span>
                        </div>
                        <button
                            type="button"
                            class="preview-clear"
                            id="clearFileBtn"
                            title="Remove file"
                        >
                            ‚úï
                        </button>
                    </div>
                </div>
            </div>

            <!-- Metadata Fields (auto-populated) -->
            <div class="meta-section" id="metaSection" style="display: none">
                <div class="meta-header">
                    <h3>üìã Song Details</h3>
                    <div
                        class="lookup-badge"
                        id="lookupBadge"
                        style="display: none"
                    >
                        <span class="lookup-dot"></span>
                        <span id="lookupBadgeText">Looking up‚Ä¶</span>
                    </div>
                </div>

                <div class="meta-grid">
                    <div class="meta-field">
                        <label for="songName">Song Name</label>
                        <input
                            type="text"
                            id="songName"
                            name="song_name"
                            placeholder="Song title"
                        />
                    </div>
                    <div class="meta-field">
                        <label for="artistName">Artist</label>
                        <input
                            type="text"
                            id="artistName"
                            name="artist"
                            placeholder="Artist name"
                        />
                    </div>
                    <div class="meta-field">
                        <label for="albumName">Album</label>
                        <input
                            type="text"
                            id="albumName"
                            name="album"
                            placeholder="Auto-detected"
                            readonly
                        />
                        <span class="field-hint" id="albumHint"></span>
                    </div>
                    <div class="meta-field meta-field-sm">
                        <label for="yearField">Year</label>
                        <input
                            type="text"
                            id="yearField"
                            name="year"
                            placeholder="‚Äî"
                            readonly
                        />
                    </div>
                    <div class="meta-field meta-field-sm">
                        <label for="genreField">Genre</label>
                        <input
                            type="text"
                            id="genreField"
                            name="genre"
                            placeholder="‚Äî"
                            readonly
                        />
                    </div>
                </div>

                <!-- Cover Art Preview -->
                <div
                    class="cover-art-row"
                    id="coverArtRow"
                    style="display: none"
                >
                    <div class="cover-art-thumb" id="coverArtThumb"></div>
                    <div class="cover-art-info">
                        <span class="cover-art-label"
                            >üé® Album art found online</span
                        >
                        <span
                            class="cover-art-detail"
                            id="coverArtDetail"
                        ></span>
                    </div>
                </div>

                <!-- Options Row -->
                <div class="options-row">
                    <label class="option-toggle" for="enableLyrics">
                        <input
                            type="checkbox"
                            id="enableLyrics"
                            name="enable_lyrics"
                            value="true"
                            checked
                        />
                        <span class="toggle-track"
                            ><span class="toggle-thumb"></span
                        ></span>
                        <span class="toggle-label">üé§ Lyrics</span>
                    </label>
                    <label class="option-toggle" for="enableAlbumArt">
                        <input
                            type="checkbox"
                            id="enableAlbumArt"
                            name="enable_album_art"
                            value="true"
                            checked
                        />
                        <span class="toggle-track"
                            ><span class="toggle-thumb"></span
                        ></span>
                        <span class="toggle-label">üé® Album Art</span>
                    </label>
                    <div class="option-select">
                        <label for="instrument">Instrument</label>
                        <select id="instrument" name="instrument">
                            <option value="guitar" selected>üé∏ Guitar</option>
                            <option value="bass">üé∏ Bass</option>
                            <option value="drums">ü•Å Drums</option>
                            <option value="vocals">üé§ Vocals</option>
                            <option value="full_mix">üéµ Full Mix</option>
                        </select>
                    </div>
                    <div class="option-select">
                        <label for="difficulty">Difficulty</label>
                        <select id="difficulty" name="difficulty">
                            <option value="easy">üü¢ Easy</option>
                            <option value="medium">üü° Medium</option>
                            <option value="hard">üü† Hard</option>
                            <option value="expert" selected>üî¥ Expert</option>
                        </select>
                    </div>
                </div>

                <!-- Generate Button -->
                <div class="gen-actions">
                    <button type="submit" class="btn-generate" id="generateBtn">
                        <span class="btn-icon" id="generateBtnIcon">üé∏</span>
                        <span class="btn-text" id="generateBtnText"
                            >Generate Guitar Chart</span
                        >
                    </button>
                </div>
            </div>

            <!-- Progress -->
            <div
                id="progressSection"
                class="progress-section"
                style="display: none"
            >
                <div class="progress-ring-container">
                    <div class="progress-ring" id="progressRing">
                        <svg viewBox="0 0 80 80">
                            <circle class="ring-bg" cx="40" cy="40" r="34" />
                            <circle
                                class="ring-fill"
                                cx="40"
                                cy="40"
                                r="34"
                                id="ringFill"
                            />
                        </svg>
                        <span class="ring-icon" id="ringIcon">üéµ</span>
                    </div>
                </div>
                <div class="progress-info">
                    <span class="progress-title" id="progressTitle"
                        >Analysing audio‚Ä¶</span
                    >
                    <span class="progress-detail" id="progressDetail"
                        >Detecting tempo, beats, and rhythm patterns</span
                    >
                </div>
            </div>
        </form>
    </div>

    <!-- Result Section -->
    <div id="resultSection" class="result-card" style="display: none">
        <div class="result-header" id="resultHeader">
            <span class="result-icon" id="resultIcon">‚úÖ</span>
            <h3 id="resultTitle">Chart Generated!</h3>
        </div>
        <div id="resultContent"></div>
        <div class="result-actions" id="resultActions">
            <button class="btn btn-primary btn-sm" onclick="resetGenerator()">
                üéµ Generate Another
            </button>
        </div>
    </div>
</div>

<style>
    .subtitle {
        color: #7f8c8d;
        margin-bottom: 24px;
        font-size: 1.05em;
    }

    /* ‚îÄ‚îÄ Generator Card ‚îÄ‚îÄ */
    .gen-card {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 28px;
        border: 1px solid #e9ecef;
    }

    /* ‚îÄ‚îÄ Drop Zone ‚îÄ‚îÄ */
    .drop-zone {
        border: 2px dashed #ced4da;
        border-radius: 12px;
        padding: 40px 24px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: white;
        position: relative;
    }

    .drop-zone:hover {
        border-color: #3498db;
        background: #f0f7ff;
    }

    .drop-zone.drag-over {
        border-color: #3498db;
        background: #e8f4ff;
        box-shadow: 0 0 0 4px rgba(52, 152, 219, 0.15);
        transform: scale(1.01);
    }

    .drop-zone.has-file {
        border-style: solid;
        border-color: #27ae60;
        background: #f0faf4;
        padding: 16px 24px;
    }

    .drop-zone-icon {
        color: #bdc3c7;
        margin-bottom: 12px;
        transition: color 0.3s;
    }

    .drop-zone:hover .drop-zone-icon {
        color: #3498db;
    }

    .drop-zone-text {
        font-size: 1.1em;
        color: #495057;
        font-weight: 600;
        margin-bottom: 6px;
    }

    .drop-zone-hint {
        font-size: 0.88em;
        color: #95a5a6;
        letter-spacing: 1px;
    }

    .drop-zone-input {
        position: absolute;
        inset: 0;
        opacity: 0;
        cursor: pointer;
    }

    .drop-zone.has-file .drop-zone-input {
        display: none;
    }

    /* ‚îÄ‚îÄ File Preview ‚îÄ‚îÄ */
    .preview-card {
        display: flex;
        align-items: center;
        gap: 14px;
    }

    .preview-icon {
        font-size: 2em;
        flex-shrink: 0;
    }

    .preview-details {
        flex: 1;
        text-align: left;
        min-width: 0;
    }

    .preview-name {
        display: block;
        font-weight: 700;
        color: #2c3e50;
        font-size: 1.05em;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .preview-size {
        display: block;
        color: #7f8c8d;
        font-size: 0.88em;
        margin-top: 2px;
    }

    .preview-clear {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: none;
        background: rgba(231, 76, 60, 0.1);
        color: #e74c3c;
        font-size: 1em;
        cursor: pointer;
        flex-shrink: 0;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .preview-clear:hover {
        background: #e74c3c;
        color: white;
    }

    /* ‚îÄ‚îÄ Metadata Section ‚îÄ‚îÄ */
    .meta-section {
        margin-top: 24px;
        animation: slideDown 0.35s ease-out;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-12px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .meta-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 16px;
    }

    .meta-header h3 {
        margin: 0;
        font-size: 1.1em;
        color: #2c3e50;
    }

    .lookup-badge {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.82em;
        color: #3498db;
        background: rgba(52, 152, 219, 0.08);
        padding: 4px 12px;
        border-radius: 20px;
    }

    .lookup-badge.found {
        color: #27ae60;
        background: rgba(39, 174, 96, 0.08);
    }

    .lookup-badge.not-found {
        color: #95a5a6;
        background: rgba(149, 165, 166, 0.08);
    }

    .lookup-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: currentColor;
        animation: pulse 1.2s ease-in-out infinite;
    }

    .lookup-badge.found .lookup-dot,
    .lookup-badge.not-found .lookup-dot {
        animation: none;
    }

    @keyframes pulse {
        0%,
        100% {
            opacity: 1;
        }
        50% {
            opacity: 0.3;
        }
    }

    .meta-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 14px;
    }

    .meta-field {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .meta-field label {
        font-size: 0.82em;
        font-weight: 600;
        color: #7f8c8d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .meta-field input,
    .meta-field select {
        padding: 10px 12px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 0.95em;
        color: #2c3e50;
        background: white;
        transition: border-color 0.2s;
    }

    .meta-field input:focus {
        outline: none;
        border-color: #3498db;
    }

    .meta-field input[readonly] {
        background: #f8f9fa;
        color: #7f8c8d;
        cursor: default;
    }

    .meta-field input.auto-filled {
        border-color: #27ae60;
        background: #f0faf4;
        color: #2c3e50;
    }

    .meta-field-sm {
        grid-column: auto;
    }

    .field-hint {
        font-size: 0.78em;
        color: #95a5a6;
        min-height: 1em;
    }

    /* ‚îÄ‚îÄ Cover Art Preview ‚îÄ‚îÄ */
    .cover-art-row {
        display: flex;
        align-items: center;
        gap: 14px;
        margin-top: 14px;
        padding: 12px 14px;
        background: rgba(39, 174, 96, 0.06);
        border: 1px solid rgba(39, 174, 96, 0.15);
        border-radius: 10px;
        animation: slideDown 0.3s ease-out;
    }

    .cover-art-thumb {
        width: 56px;
        height: 56px;
        border-radius: 8px;
        background: #e9ecef;
        overflow: hidden;
        flex-shrink: 0;
    }

    .cover-art-thumb img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .cover-art-info {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .cover-art-label {
        font-weight: 600;
        font-size: 0.9em;
        color: #27ae60;
    }

    .cover-art-detail {
        font-size: 0.82em;
        color: #7f8c8d;
    }

    /* ‚îÄ‚îÄ Options Row ‚îÄ‚îÄ */
    .options-row {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-top: 20px;
        padding-top: 18px;
        border-top: 1px solid #e9ecef;
        flex-wrap: wrap;
    }

    .option-toggle {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        font-size: 0.92em;
        color: #495057;
        user-select: none;
    }

    .option-toggle input {
        display: none;
    }

    .toggle-track {
        width: 36px;
        height: 20px;
        background: #ced4da;
        border-radius: 10px;
        position: relative;
        transition: background 0.2s;
    }

    .toggle-thumb {
        position: absolute;
        top: 2px;
        left: 2px;
        width: 16px;
        height: 16px;
        background: white;
        border-radius: 50%;
        transition: transform 0.2s;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }

    .option-toggle input:checked + .toggle-track {
        background: #27ae60;
    }

    .option-toggle input:checked + .toggle-track .toggle-thumb {
        transform: translateX(16px);
    }

    .toggle-label {
        font-weight: 500;
    }

    .option-select {
        margin-left: auto;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.92em;
    }

    .option-select label {
        color: #7f8c8d;
        font-weight: 600;
        font-size: 0.85em;
        text-transform: uppercase;
    }

    .option-select select {
        padding: 6px 10px;
        border: 2px solid #e9ecef;
        border-radius: 6px;
        background: white;
        font-size: 0.95em;
        color: #2c3e50;
    }

    /* ‚îÄ‚îÄ Generate Button ‚îÄ‚îÄ */
    .gen-actions {
        margin-top: 20px;
    }

    .btn-generate {
        width: 100%;
        padding: 16px;
        border: none;
        border-radius: 10px;
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        color: white;
        font-size: 1.1em;
        font-weight: 700;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: all 0.3s;
        box-shadow: 0 4px 14px rgba(52, 152, 219, 0.3);
    }

    .btn-generate:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
    }

    .btn-generate:active:not(:disabled) {
        transform: translateY(0);
    }

    .btn-generate:disabled {
        opacity: 0.7;
        cursor: wait;
    }

    .btn-generate .btn-icon {
        font-size: 1.2em;
    }

    /* ‚îÄ‚îÄ Progress Section ‚îÄ‚îÄ */
    .progress-section {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-top: 24px;
        padding: 20px 24px;
        background: white;
        border-radius: 10px;
        border: 1px solid #e9ecef;
        animation: slideDown 0.3s ease-out;
    }

    .progress-ring-container {
        flex-shrink: 0;
    }

    .progress-ring {
        width: 64px;
        height: 64px;
        position: relative;
    }

    .progress-ring svg {
        transform: rotate(-90deg);
    }

    .ring-bg {
        fill: none;
        stroke: #e9ecef;
        stroke-width: 4;
    }

    .ring-fill {
        fill: none;
        stroke: #3498db;
        stroke-width: 4;
        stroke-dasharray: 213.6;
        stroke-dashoffset: 213.6;
        stroke-linecap: round;
        transition: stroke-dashoffset 0.5s ease;
    }

    .ring-fill.indeterminate {
        animation: ring-spin 1.4s linear infinite;
        stroke-dashoffset: 160;
    }

    @keyframes ring-spin {
        0% {
            transform: rotate(0deg);
        }
        100% {
            transform: rotate(360deg);
        }
    }

    .ring-icon {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.4em;
    }

    .progress-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .progress-title {
        font-weight: 700;
        color: #2c3e50;
        font-size: 1em;
    }

    .progress-detail {
        color: #7f8c8d;
        font-size: 0.88em;
    }

    /* ‚îÄ‚îÄ Result Card ‚îÄ‚îÄ */
    .result-card {
        margin-top: 20px;
        background: white;
        border-radius: 12px;
        padding: 24px;
        border: 2px solid #27ae60;
        box-shadow: 0 4px 16px rgba(39, 174, 96, 0.12);
        animation: slideDown 0.35s ease-out;
    }

    .result-card.error {
        border-color: #e74c3c;
        box-shadow: 0 4px 16px rgba(231, 76, 60, 0.12);
    }

    .result-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 16px;
    }

    .result-icon {
        font-size: 1.6em;
    }

    .result-header h3 {
        margin: 0;
        color: #27ae60;
        font-size: 1.2em;
    }

    .result-card.error .result-header h3 {
        color: #e74c3c;
    }

    .result-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        gap: 12px;
        margin-bottom: 16px;
    }

    .stat-box {
        text-align: center;
        padding: 12px 8px;
        background: #f8f9fa;
        border-radius: 8px;
    }

    .stat-val {
        display: block;
        font-size: 1.4em;
        font-weight: 700;
        color: #3498db;
    }

    .stat-lbl {
        display: block;
        font-size: 0.78em;
        color: #95a5a6;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-top: 2px;
    }

    .result-info {
        font-size: 0.92em;
        color: #495057;
        line-height: 1.7;
    }

    .result-info strong {
        color: #2c3e50;
    }

    .result-info code {
        background: #e9ecef;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.9em;
    }

    .result-actions {
        margin-top: 16px;
        padding-top: 14px;
        border-top: 1px solid #e9ecef;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    /* ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ */
    @media (max-width: 768px) {
        .gen-card {
            padding: 18px;
        }
        .meta-grid {
            grid-template-columns: 1fr;
        }
        .options-row {
            flex-direction: column;
            align-items: flex-start;
        }
        .option-select {
            margin-left: 0;
        }
        .progress-section {
            flex-direction: column;
            text-align: center;
        }
        .result-stats {
            grid-template-columns: repeat(2, 1fr);
        }
    }
</style>
{% endblock %} {% block extra_js %}
<script>
    // ‚îÄ‚îÄ DOM refs ‚îÄ‚îÄ
    const dropZone = document.getElementById("dropZone");
    const fileInput = document.getElementById("fileInput");
    const filePreview = document.getElementById("filePreview");
    const dropZoneContent = document.getElementById("dropZoneContent");
    const clearFileBtn = document.getElementById("clearFileBtn");
    const metaSection = document.getElementById("metaSection");
    const generatorForm = document.getElementById("generatorForm");
    const generateBtn = document.getElementById("generateBtn");
    const progressSection = document.getElementById("progressSection");
    const progressTitle = document.getElementById("progressTitle");
    const progressDetail = document.getElementById("progressDetail");
    const ringFill = document.getElementById("ringFill");
    const ringIcon = document.getElementById("ringIcon");
    const resultSection = document.getElementById("resultSection");
    const resultTitle = document.getElementById("resultTitle");
    const resultIcon = document.getElementById("resultIcon");
    const resultContent = document.getElementById("resultContent");
    const lookupBadge = document.getElementById("lookupBadge");
    const lookupBadgeText = document.getElementById("lookupBadgeText");

    // ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ
    function formatFileSize(bytes) {
        if (bytes === 0) return "0 B";
        const k = 1024;
        const sizes = ["B", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + " " + sizes[i];
    }

    function formatDuration(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = Math.round(seconds % 60);
        return `${mins}:${secs.toString().padStart(2, "0")}`;
    }

    // ‚îÄ‚îÄ Smart Filename Parsing (client-side fallback) ‚îÄ‚îÄ
    function parseFilenameLocal(filename) {
        let stem = filename.replace(/\.[^/.]+$/, ""); // remove extension

        // Step 1: Strip leading track-number prefixes
        // Handles "05-...", "05. ...", "05 ...", "5 - ..." etc.
        const trackMatch = stem.match(/^\d{1,3}\s*[-\.]\s*/);
        if (trackMatch) {
            stem = stem.slice(trackMatch[0].length);
        }

        // Step 2: Try spaced separators (highest confidence first)
        const seps = [" - ", " ‚Äì ", " ‚Äî ", " _ "];
        let artist = "";
        let title = stem;

        for (const sep of seps) {
            if (stem.includes(sep)) {
                const parts = stem.split(sep);
                if (parts.length >= 2) {
                    const candidateArtist = parts[0].trim();
                    const candidateTitle = parts.slice(1).join(sep).trim();
                    if (!candidateArtist || !candidateTitle) continue;
                    // Skip if "artist" is just a track number
                    if (/^\d{1,3}$/.test(candidateArtist)) {
                        title = candidateTitle;
                    } else {
                        artist = candidateArtist;
                        title = candidateTitle;
                    }
                    break;
                }
            }
        }

        // Step 3: If no spaced separator matched, try bare "-" but only
        // when at least one side is multi-word (contains space or underscore)
        // so we don't split hyphenated words like "Re-Enter".
        if (!artist && title.includes("-")) {
            const idx = title.indexOf("-");
            const left = title.slice(0, idx).trim();
            const right = title.slice(idx + 1).trim();
            const isMultiWord = (s) => s.includes(" ") || s.includes("_");
            if (left && right && (isMultiWord(left) || isMultiWord(right))) {
                if (/^\d{1,3}$/.test(left)) {
                    title = right;
                } else {
                    artist = left;
                    title = right;
                }
            }
        }

        // Step 4: Fallback - strip remaining "01. Title" or "01 Title" patterns
        if (!artist) {
            const m = title.match(/^\d{1,3}\.?\s+(.+)$/);
            if (m) title = m[1];
        }

        // Clean: replace _ and isolated - with spaces, collapse whitespace
        title = cleanName(title);
        artist = cleanName(artist);

        return { song_name: title, artist: artist };
    }

    function cleanName(raw) {
        let text = raw.trim();
        // Strip common video/audio tags
        const stripPatterns = [
            /\(Official\s*(Music\s*)?Video\)/gi,
            /\(Official\s*Audio\)/gi,
            /\(Lyric\s*Video\)/gi,
            /\(Audio\)/gi,
            /\(Visualizer\)/gi,
            /\[Official\s*(Music\s*)?Video\]/gi,
            /\[Official\s*Audio\]/gi,
            /\[Lyric\s*Video\]/gi,
            /\[Audio\]/gi,
            /\[Visualizer\]/gi,
            /\(feat\.?\s*[^)]+\)/gi,
            /\[feat\.?\s*[^\]]+\]/gi,
            /\(ft\.?\s*[^)]+\)/gi,
            /\d{3,4}\s*kbps/gi,
            /\(\d{4}\)/g,
            /\[\d{4}\]/g,
        ];
        for (const pat of stripPatterns) {
            text = text.replace(pat, "");
        }
        // Replace _ and isolated dashes with spaces
        text = text.replace(/_/g, " ");
        text = text.replace(/\s*-\s+|\s+-\s*/g, " ");
        // Collapse whitespace
        text = text.replace(/\s+/g, " ").trim();
        // Smart title case
        text = smartTitleCase(text);
        return text;
    }

    const lowercaseWords = new Set([
        "a",
        "an",
        "the",
        "and",
        "but",
        "or",
        "nor",
        "for",
        "yet",
        "so",
        "in",
        "on",
        "at",
        "to",
        "by",
        "of",
        "up",
        "as",
        "is",
        "if",
        "it",
        "vs",
        "vs.",
    ]);

    function smartTitleCase(text) {
        const words = text.split(" ");
        return words
            .map((word, i) => {
                // Preserve all-caps acronyms (2+ chars)
                if (
                    word.length >= 2 &&
                    word === word.toUpperCase() &&
                    /[A-Z]/.test(word)
                ) {
                    return word;
                }
                // First/last word always capitalized
                if (i === 0 || i === words.length - 1) {
                    return (
                        word.charAt(0).toUpperCase() +
                        word.slice(1).toLowerCase()
                    );
                }
                // Articles/prepositions lowercase
                if (lowercaseWords.has(word.toLowerCase())) {
                    return word.toLowerCase();
                }
                return (
                    word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
                );
            })
            .join(" ");
    }

    // ‚îÄ‚îÄ Debounce ‚îÄ‚îÄ
    let lookupTimeout = null;

    // ‚îÄ‚îÄ File Selection ‚îÄ‚îÄ
    function onFileSelected(file) {
        // Show preview
        document.getElementById("previewName").textContent = file.name;
        document.getElementById("previewSize").textContent = formatFileSize(
            file.size,
        );
        dropZoneContent.style.display = "none";
        filePreview.style.display = "block";
        dropZone.classList.add("has-file");

        // Parse filename
        const parsed = parseFilenameLocal(file.name);

        const songInput = document.getElementById("songName");
        const artistInput = document.getElementById("artistName");

        songInput.value = parsed.song_name;
        artistInput.value = parsed.artist;

        // Clear album/year/genre
        document.getElementById("albumName").value = "";
        document.getElementById("yearField").value = "";
        document.getElementById("genreField").value = "";
        document.getElementById("albumHint").textContent = "";
        document.getElementById("coverArtRow").style.display = "none";

        // Show meta section
        metaSection.style.display = "block";

        // Also call the backend parser for better results, then lookup
        callBackendParse(file.name).then(() => {
            triggerMetadataLookup();
        });

        // Scroll meta into view
        setTimeout(() => {
            metaSection.scrollIntoView({
                behavior: "smooth",
                block: "nearest",
            });
        }, 100);
    }

    async function callBackendParse(filename) {
        try {
            const resp = await fetch("/api/parse-filename", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ filename: filename }),
            });
            if (resp.ok) {
                const data = await resp.json();
                const songInput = document.getElementById("songName");
                const artistInput = document.getElementById("artistName");
                if (data.song_name) songInput.value = data.song_name;
                if (data.artist) artistInput.value = data.artist;
            }
        } catch (e) {
            // Silently fall back to client-side parsing
            console.debug("Backend parse failed, using client-side:", e);
        }
    }

    function triggerMetadataLookup() {
        if (lookupTimeout) clearTimeout(lookupTimeout);
        lookupTimeout = setTimeout(doMetadataLookup, 300);
    }

    async function doMetadataLookup() {
        const title = document.getElementById("songName").value.trim();
        const artist = document.getElementById("artistName").value.trim();

        if (!title) return;

        // Show badge
        lookupBadge.style.display = "flex";
        lookupBadge.className = "lookup-badge";
        lookupBadgeText.textContent = "Looking up‚Ä¶";

        try {
            const resp = await fetch("/api/lookup-metadata", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ title, artist }),
            });

            if (!resp.ok) throw new Error("HTTP " + resp.status);
            const data = await resp.json();

            if (data.found) {
                lookupBadge.className = "lookup-badge found";
                lookupBadgeText.textContent = "Metadata found";

                // Fill in fields
                if (data.album) {
                    const albumInput = document.getElementById("albumName");
                    albumInput.value = data.album;
                    albumInput.classList.add("auto-filled");
                }
                if (data.year) {
                    const yearInput = document.getElementById("yearField");
                    yearInput.value = data.year;
                    yearInput.classList.add("auto-filled");
                }
                if (data.genre) {
                    const genreInput = document.getElementById("genreField");
                    genreInput.value = data.genre;
                    genreInput.classList.add("auto-filled");
                }
                if (
                    data.artist &&
                    !document.getElementById("artistName").value.trim()
                ) {
                    document.getElementById("artistName").value = data.artist;
                }

                // Show that cover art will be available
                if (data.release_mbid || data.release_group_mbid) {
                    document.getElementById("coverArtRow").style.display =
                        "flex";
                    document.getElementById("coverArtDetail").textContent =
                        `From "${data.album || "Unknown Album"}"${data.year ? " (" + data.year + ")" : ""}`;
                    // We don't have the actual image URL yet (fetched during generation)
                    document.getElementById("coverArtThumb").innerHTML =
                        '<div style="width:100%;height:100%;background:#27ae60;display:flex;align-items:center;justify-content:center;color:white;font-size:1.5em;border-radius:8px;">üé®</div>';
                }

                // Update album hint
                const source = data.lookup_source || "musicbrainz";
                document.getElementById("albumHint").textContent =
                    `via ${source}`;
            } else {
                lookupBadge.className = "lookup-badge not-found";
                lookupBadgeText.textContent = "No match found";
            }
        } catch (e) {
            lookupBadge.className = "lookup-badge not-found";
            lookupBadgeText.textContent = "Lookup unavailable";
            console.debug("Metadata lookup error:", e);
        }
    }

    function clearFile() {
        fileInput.value = "";
        dropZoneContent.style.display = "block";
        filePreview.style.display = "none";
        dropZone.classList.remove("has-file");
        metaSection.style.display = "none";
        lookupBadge.style.display = "none";

        // Clear fields
        document.getElementById("songName").value = "";
        document.getElementById("artistName").value = "";
        document.getElementById("albumName").value = "";
        document.getElementById("yearField").value = "";
        document.getElementById("genreField").value = "";
        document.getElementById("albumName").classList.remove("auto-filled");
        document.getElementById("yearField").classList.remove("auto-filled");
        document.getElementById("genreField").classList.remove("auto-filled");
        document.getElementById("coverArtRow").style.display = "none";
    }

    // ‚îÄ‚îÄ Drag and Drop ‚îÄ‚îÄ
    ["dragenter", "dragover"].forEach((evt) => {
        dropZone.addEventListener(evt, (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.add("drag-over");
        });
    });

    ["dragleave", "drop"].forEach((evt) => {
        dropZone.addEventListener(evt, (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.remove("drag-over");
        });
    });

    dropZone.addEventListener("drop", (e) => {
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;
            onFileSelected(files[0]);
        }
    });

    fileInput.addEventListener("change", function () {
        if (this.files.length > 0) {
            onFileSelected(this.files[0]);
        }
    });

    clearFileBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        clearFile();
    });

    // Re-lookup when user edits song name or artist
    document
        .getElementById("songName")
        .addEventListener("input", triggerMetadataLookup);
    document
        .getElementById("artistName")
        .addEventListener("input", triggerMetadataLookup);

    // Update Generate button text/icon when instrument changes
    document
        .getElementById("instrument")
        .addEventListener("change", function () {
            const iconMap = {
                guitar: "üé∏",
                bass: "üé∏",
                drums: "ü•Å",
                vocals: "üé§",
                full_mix: "üéµ",
            };
            const nameMap = {
                guitar: "Guitar",
                bass: "Bass",
                drums: "Drums",
                vocals: "Vocals",
                full_mix: "Full Mix",
            };
            const val = this.value;
            document.getElementById("generateBtnIcon").textContent =
                iconMap[val] || "üé∏";
            document.getElementById("generateBtnText").textContent =
                `Generate ${nameMap[val] || "Guitar"} Chart`;
        });

    // ‚îÄ‚îÄ Form Submission ‚îÄ‚îÄ
    generatorForm.addEventListener("submit", async function (e) {
        e.preventDefault();

        if (!fileInput.files || fileInput.files.length === 0) {
            alert("Please select an audio file first.");
            return;
        }

        const file = fileInput.files[0];
        const songName = document.getElementById("songName").value.trim();
        const artist = document.getElementById("artistName").value.trim();
        const instrument = document.getElementById("instrument").value;
        const difficulty = document.getElementById("difficulty").value;
        const enableLyrics = document.getElementById("enableLyrics").checked;
        const enableAlbumArt =
            document.getElementById("enableAlbumArt").checked;

        // Disable form
        generateBtn.disabled = true;
        generateBtn.querySelector(".btn-text").textContent = "Generating‚Ä¶";

        // Show progress
        progressSection.style.display = "flex";
        ringFill.classList.add("indeterminate");
        ringIcon.textContent = "üéµ";
        progressTitle.textContent = "Analysing audio‚Ä¶";
        progressDetail.textContent =
            "Detecting tempo, beats, and rhythm patterns. This can take 15‚Äì60 seconds.";
        resultSection.style.display = "none";

        // Build form data
        const instrumentIcons = {
            guitar: "üé∏",
            bass: "üé∏",
            drums: "ü•Å",
            vocals: "üé§",
            full_mix: "üéµ",
        };
        const instrumentNames = {
            guitar: "Guitar",
            bass: "Bass",
            drums: "Drums",
            vocals: "Vocals",
            full_mix: "Full Mix",
        };
        progressTitle.textContent = `Separating ${instrumentNames[instrument] || "Guitar"} stem & generating chart...`;

        const formData = new FormData();
        formData.append("file", file);
        if (songName) formData.append("song_name", songName);
        if (artist) formData.append("artist", artist);
        formData.append("instrument", instrument);
        formData.append("difficulty", difficulty);
        formData.append("enable_lyrics", enableLyrics ? "true" : "false");
        formData.append("enable_album_art", enableAlbumArt ? "true" : "false");
        formData.append("auto_lookup", "true");

        try {
            // Update progress
            const instIcon = instrumentIcons[instrument] || "üé∏";
            const instName = instrumentNames[instrument] || "Guitar";

            setTimeout(() => {
                if (generateBtn.disabled) {
                    progressTitle.textContent = `Generating ${instName} chart‚Ä¶`;
                    progressDetail.textContent =
                        instrument === "drums"
                            ? "Detecting kick, snare, hi-hat & tom patterns"
                            : instrument === "bass"
                              ? "Isolating bass frequencies and building note patterns"
                              : "Building note patterns, HOPO markers, and star power sections";
                    ringIcon.textContent = instIcon;
                }
            }, 5000);

            setTimeout(() => {
                if (generateBtn.disabled) {
                    progressTitle.textContent = "Uploading to Nextcloud‚Ä¶";
                    progressDetail.textContent =
                        "Almost done ‚Äî uploading chart and audio files";
                    ringIcon.textContent = "‚òÅÔ∏è";
                }
            }, 15000);

            const response = await fetch("/api/generate", {
                method: "POST",
                body: formData,
            });

            const result = await response.json();

            // Hide progress
            progressSection.style.display = "none";

            if (response.ok && !result.error) {
                showSuccess(result, songName, artist, difficulty, instrument);
            } else {
                showError(
                    result.detail || result.error || "Chart generation failed",
                );
            }
        } catch (error) {
            progressSection.style.display = "none";
            showError("Network error: " + error.message);
        } finally {
            generateBtn.disabled = false;
            const curInst = document.getElementById("instrument").value;
            const resetNameMap = {
                guitar: "Guitar",
                bass: "Bass",
                drums: "Drums",
                vocals: "Vocals",
                full_mix: "Full Mix",
            };
            generateBtn.querySelector(".btn-text").textContent =
                `Generate ${resetNameMap[curInst] || "Guitar"} Chart`;
        }

        resultSection.scrollIntoView({ behavior: "smooth", block: "nearest" });
    });

    function showSuccess(result, songName, artist, difficulty, instrument) {
        resultSection.className = "result-card";
        resultSection.style.display = "block";
        resultIcon.textContent = "‚úÖ";

        const instDisplayIcons = {
            guitar: "üé∏",
            bass: "üé∏",
            drums: "ü•Å",
            vocals: "üé§",
            full_mix: "üéµ",
        };
        const instDisplayNames = {
            guitar: "Guitar",
            bass: "Bass",
            drums: "Drums",
            vocals: "Vocals",
            full_mix: "Full Mix",
        };
        const chartedInst = result.instrument || instrument || "guitar";
        const instIcon = instDisplayIcons[chartedInst] || "üé∏";
        const instLabel = instDisplayNames[chartedInst] || "Guitar";
        resultTitle.textContent = `${instIcon} ${instLabel} Chart Generated!`;

        const features = [];
        if (result.has_lyrics) features.push("üé§ Lyrics");
        if (result.has_album_art) features.push("üé® Art");
        if (result.lookup_source) features.push("üîç Metadata");

        let html = '<div class="result-stats">';
        html += `<div class="stat-box"><span class="stat-val">${instIcon}</span><span class="stat-lbl">${instLabel}</span></div>`;
        html += `<div class="stat-box"><span class="stat-val">${result.tempo ? Math.round(result.tempo) : "?"}</span><span class="stat-lbl">BPM</span></div>`;
        html += `<div class="stat-box"><span class="stat-val">${result.duration ? formatDuration(result.duration) : "?"}</span><span class="stat-lbl">Duration</span></div>`;
        html += `<div class="stat-box"><span class="stat-val">${result.total_notes || "?"}</span><span class="stat-lbl">Notes</span></div>`;
        html += `<div class="stat-box"><span class="stat-val">${(result.difficulty || difficulty).charAt(0).toUpperCase() + (result.difficulty || difficulty).slice(1)}</span><span class="stat-lbl">Difficulty</span></div>`;
        if (features.length > 0) {
            html += `<div class="stat-box"><span class="stat-val" style="font-size:1em">${features.join(" ")}</span><span class="stat-lbl">Features</span></div>`;
        }
        html += "</div>";

        html += '<div class="result-info">';
        html += `<p><strong>üéµ</strong> ${result.song_name || songName || "Unknown"}</p>`;
        html += `<p><strong>üé§</strong> ${result.artist || artist || "Unknown Artist"}</p>`;
        if (result.album && result.album !== "Generated") {
            html += `<p><strong>üíø</strong> ${result.album}${result.year ? " (" + result.year + ")" : ""}</p>`;
        }
        if (result.genre && result.genre !== "Generated") {
            html += `<p><strong>üè∑Ô∏è</strong> ${result.genre}</p>`;
        }
        if (result.id) {
            html += `<p><strong>üÜî</strong> Song #${result.id} ‚Äî <a href="/songs/${result.id}/edit" class="btn btn-primary btn-sm">‚úèÔ∏è Edit</a></p>`;
        }
        html += "</div>";

        resultContent.innerHTML = html;

        // Update result actions
        const actionsHtml = [
            '<button class="btn btn-primary btn-sm" onclick="resetGenerator()">üéµ Generate Another</button>',
        ];
        if (result.id) {
            actionsHtml.push(
                `<a href="/chart-viewer?song_id=${result.id}" class="btn btn-secondary btn-sm">üìä View Chart</a>`,
            );
        }
        document.getElementById("resultActions").innerHTML =
            actionsHtml.join("");
    }

    function showError(message) {
        resultSection.className = "result-card error";
        resultSection.style.display = "block";
        resultIcon.textContent = "‚ùå";
        resultTitle.textContent = "Generation Failed";
        resultContent.innerHTML = `<div class="alert alert-danger">${message}</div>`;
    }

    function resetGenerator() {
        generatorForm.reset();
        clearFile();
        progressSection.style.display = "none";
        resultSection.style.display = "none";
        window.scrollTo({ top: 0, behavior: "smooth" });
    }
</script>
{% endblock %}
